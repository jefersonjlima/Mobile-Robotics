\chapterauthor{Jeferson J. Lima}{Departamento de Informática (DAINF) \\Universidade Tecnológica Federal do Paraná (UTFPR)}
\chapter{Cinemática e Dinâmica de Robôs Móveis com Rodas}


\section{Introdução}\label{intro}
% 2. Cinemática e Dinâmica de Robôs Móveis com Rodas
% 	2.1 Cinemática Direta e Inversa
% 		2.1.1 Cinemática Direta e Inversa
% 		2.1.1 Cinemática de Robôs Móveis com Rodas
% 	2.2 Restrições de Movimento
% 		2.2.1 Sistemas Holonômicos
% 		2.2.2 Sistemas Não-Holonômicos
% 	2.3 Modelagem de Robô Móvel com restrições de Movimento.
% 3. Controle Moderno para Robótica Móvel
% 	3.1 Lyapunov-based Controle
% 	3.2 SDRE Controle
% 4. Eventos Não Deterministicos em Robótica Móvel
% 	4.1 Estimação de Estados
% 	4.2 Filtro Bayesiano
% 	4.3 Filtro de Kalman
% 		4.3.1 Filtro de Kalman Estendido

A humanidade é fascinada pelo movimento das rodas a milhares de anos, isso intriga até os dias de hoje, o homem moderno.
Na matemática há áreas específicas para descrever o movimento dos corpos, ou para o nosso interesse nesse capítulo, a cinemática dos robôs. 
Um modelo cinemático de um robô, com rodas ou pernas, descreve as relações geométricas entre que dão forma ao próposito deste robô.

Em resumo, os modelos cinemáticos estão relacionadas a como as velocidades dos elementos do robô interagem entre si e o espaço.

\section{Rotação, Translação e Transformação Homogênea}\label{rotacao}
 
Para representação de posicionamento e orientação de um sistema de coordenadas faz se necessário seguir a metodologia do sistema universal de coordenadas.

De acordo com \cite{craig2009introduction} uma vez estabelecido o sistema de coordenada como um vetor de posição $\mathbb{R}^{3 \times 1}$, composto pelas coordenadas $X,Y$ e $Z$, podemos então representar os operadores de rotação, translação e transformação homogênea como operações matriciais. Desta forma, um ponto ${}^A\mathbf{P}$ representa a distância ao longo dos eixos do plano $\{A\}$. Os elementos individuais de ${}^A\mathbf{P}$ podem ser visto pela equação \eqref{eq:cine1}.

\begin{equation}\label{eq:cine1}
    {}^A\mathbf{P} = \begin{bmatrix}
    p_x\\ p_y \\ p_z
    \end{bmatrix}.
    \end{equation}

    A representação gráfica de ${}^A\mathbf{P}$ pode ser vista na figura \ref{fig:cine1f}. 

\begin{figure}[!ht]
  \centering
  \begin{tikzpicture}[scale=0.8]
  \node(p0) at (0,0){};
  \draw [->] (p0.center) --++(0,3) node[right] {$ Y_A$};
  \draw [->, rotate =120] (p0.center) --++(0,3) node[below] {$ Z_A$};
  \draw [->, rotate =240] (p0.center) --++(0,3) node[below] {$ X_A$};
  \draw [->] (p0.center) --++(2.5,0.5) node(B)[above,rotate=30] {${}^A\mathbf{P}$};
  \node at (-1.5,2.5) {$\{A\}$};
  \end{tikzpicture}
  \caption{Vetor em relação ao plano $\{A\}$}
  \label{fig:cine1f}
  \end{figure}

    Além da definição das coordenadas de um vetor, torna-se necessário definir a orientação desse corpo no espaço. O vetor definido por ${}^A\mathbf{P}$ pode ser rotacionado pela matriz de rotação $\mathbf{R}$, conforme a equação \eqref{eq:cine2}.
 
    \begin{equation}\label{eq:cine2}
    {}_A^B
    \mathbf{R} = 
    \begin{bmatrix}
    r_{11} & r_{11} & r_{11}\\
    r_{21} & r_{21} & r_{21}\\
    r_{31} & r_{31} & r_{31}\\
    \end{bmatrix}
    \end{equation}


    Na figura abaixo, a posição de ${}^A\mathbf{P}$ (sistema de referência global) em relação a ${}^B\mathbf{P}$ é encontrado através da multiplicação da matriz de ${}_B^A \mathbf{R}(\theta)$ (lê-se rotação do sistema de referência $B$ em $A$) pela posição de ${}^B\mathbf{P}$

    \begin{figure}[!ht]
        \centering
        \begin{tikzpicture}[scale=0.8]
            \node(p0) at (0,0){};
            \draw [->] (p0.center) --++(0,3) node[right] {$\hat Y_A$};
            \draw [->, rotate =120] (p0.center) --++(0,3) node[below] {$\hat Z_A$};
            \draw [->, rotate =240] (p0.center) --++(0,3) node[below] {$\hat X_A$};
            \draw [->, rotate =-10, gray] (p0.center) --++(1.5,2) node(A)[above,rotate=30] {${}^A\mathbf{P}$};
            \node(p1) at (6,1){};
            \draw [->, rotate =30, red] (p0.center) --++(0,3) node[right,rotate=30] {$\hat Y_B$};
            \draw [->, rotate =150, red] (p0.center) --++(0,3) node[below,rotate=30] {$\hat Z_B$};
            \draw [->, rotate =270, red] (p0.center) --++(0,3) node[below,rotate=30] {$\hat X_B$};
            \draw [->, rotate =20, red] (p0.center) --++(1.5,2) node(B)[above,rotate=30] {${}^B\mathbf{P}$};
        \end{tikzpicture}
        \caption{Vetor em rotação no plano $\{A\}$}
        \label{fig:vetor_rot}
    \end{figure}
    
%     Abaixo segue um exercício numérico de fixação.

%     \begin{shortbox}
%         \Boxhead{Exercício de Fixação}
%         Como exemplo, uma rotação $\theta$ de ${}^AP$ em torno do eixo $Z$ é descrita pela figura  \eqref{fig:vetor_rot}. 
        
        
        
%         Pode-se observar que é adicionado uma coluna e linhas com zeros e uma nova linha em  \eqref{eq:cine3}, essa notação torna-se necessária pois será posteriormente apresentando o operador de translação.

%         \begin{equation}\label{eq:cine3}
%         {}^B\mathcal{P} = {}_A^B \mathbf{R}(\theta) {}^A\mathbf{P} = 
%         \begin{bmatrix}
%         \cos(\theta) & \sin(\theta) & 0 & 0\\
%         \sin(\theta) & \cos(\theta) & 0 & 0\\
%         0 & 0 & 1 & 0\\ 
%         0 & 0 & 0 & 1\\
%         \end{bmatrix}.
%         \begin{bmatrix}
%         {}^Ap_x\\
%         {}^Ap_y\\
%         {}^Ap_z\\
%         1
%         \end{bmatrix}
%         \end{equation}
%         \begin{center}
%             Resposta:
    
% \qrcode[height=0.8in]{
% [-1,  0,  0,  0],
% [ 0, -1,  0,  0],
% [ 0,  0,  1,  0],
% [ 0,  0,  0,  1]]
% }
%     \end{center}
    
%     \end{shortbox}

    A rotação pode acontecer tanto em $x, y$ ou $z$, conforme é mostrado abaixo:

    \begin{equation*}
        \mathbf{R}_x(\theta) =
        \begin{bmatrix}
            1 & 0            & 0             \\
            0 & \cos(\theta) & -\sin(\theta) \\
            0 & \sin(\theta) & \cos(\theta)  \\
        \end{bmatrix} \text{, eixo $x$ fixo}
    \end{equation*}
    \begin{equation*}
        \mathbf{R}_y(\theta) =
        \begin{bmatrix}
            \cos(\theta)  & 0 & \sin(\theta) \\
            0             & 1 & 0            \\
            -\sin(\theta) & 0 & \cos(\theta) \\
        \end{bmatrix} \text{, eixo $y$ fixo}
    \end{equation*}
    \begin{equation*}
        \mathbf{R}_z(\theta) =
        \begin{bmatrix}
            \cos(\theta) & -\sin(\theta) & 0 \\
            \sin(\theta) & \cos(\theta) & 0 \\
            0            & 0            & 1 \\
        \end{bmatrix} \text{, eixo $z$ fixo}
    \end{equation*}

    Frequentemente o sistema de referência $\{A\}$ não coincide em nenhum coordenada de $\{B\}$, sendo assim, deve-se representar o deslocamento entre os planos. Esse deslocamento é chamado de translação, e dá-se pelo operador translacional $\mathbf{D}_A(q)$, onde ${}^A\mathbf{Q}$ representa uma translação entre os planos $\{A\}$ e $\{B\}$ e é expresso pela equação \eqref{eq:cine4}.

    \begin{equation}\label{eq:cine4}
    {}^A\mathbf{Q} =
    \begin{bmatrix}
    q_x\\ q_y \\ q_z
    \end{bmatrix}, \qquad \mathrm{e} \qquad
    \mathbf{D}_A = 
    \begin{bmatrix}
    1 & 0 & 0 & q_x\\
    0 & 1 & 0 & q_y\\
    0 & 0 & 1 & q_z\\
    0 & 0 & 0 & 1
    \end{bmatrix}.
    \end{equation}
    
    Adota-se agora a notação para translação e rotação de um vetor, conforme a equação \eqref{eq:cine5}. Observa-se que a matriz $\mathbf{D}_A$ foi incorporada pela nova notação.
    
    \begin{equation}\label{eq:cine5}
    \begin{bmatrix}
    {}^B_A\mathbf{P}\\ 1
    \end{bmatrix}
    =
    \underbrace {
    \left[
    \begin{matrix}
    & {}_B^A\mathbf{R}& \\ \hline
    0 & 0 & 0\\
    \end{matrix} \right.
    \left.
    \vline
    \begin{matrix}
    {}^A\mathbf{Q}\\ \hline
    1
    \end{matrix} \right]
    }_{{}^A_B\mathcal{A}}
    \begin{bmatrix}
    {}^B\mathbf{P}\\
    1
    \end{bmatrix}
    \end{equation}
    
    
    Na equação \eqref{eq:cine5} a matriz ${}^A_B\mathcal{A}$ representa a matriz de transformação homogênea, neste caso, composta pela matriz de rotação ${}^A_B \mathbf{R}$ e de translação ${}^A\mathbf{Q}$. Pode-se ver graficamente o resultado da operação da equação \eqref{eq:cine5} pela figura \ref{fig:cine2}
    
    \begin{figure}[!ht]
    \centering
    \begin{tikzpicture}
    \node(p0) at (0,0){};
    \draw [->] (p0.center) --++(0,3) node[right] {$\hat Y_A$};
    \draw [->, rotate =120] (p0.center) --++(0,3) node[below] {$\hat Z_A$};
    \draw [->, rotate =240] (p0.center) --++(0,3) node[below] {$\hat X_A$};
    \draw [->, dotted] (p0.center) --++(1.5,4) node(B)[above,rotate=30] {${}^B\mathbf{P}$};
    \node(p1) at (6,1){};
    \draw [->, rotate =30] (p1.center) --++(0,3) node[right,rotate=30] {$\hat Y_B$};
    \draw [->, rotate =150] (p1.center) --++(0,3) node[below,rotate=30] {$\hat Z_B$};
    \draw [->, rotate =270] (p1.center) --++(0,3) node[below,rotate=30] {$\hat X_B$};
    \draw [->] (p1.center) --++(1.5,4) node(B)[above,rotate=30] {${}^B\mathbf{P}$};
    \draw [dotted,-latex] (p0)  -- (p1) node[midway, fill=white]{${}^A\mathbf{Q}$};
    \draw [-latex,dashed] (p0)  -- (B);
    \node at (-1.5,2.5) {$\{A\}$};
    \node at (4,2.5)  [rotate=30]   {$\{B\}$};
    \end{tikzpicture}
    \caption{Transformação homogênea do ponto ${}^AP$ pelos operadores de rotação e translação}
    \label{fig:cine2}
    \end{figure}
    
    Na forma generalizada, a transformação homogênea ${}^{i}_0\mathbf{T}$ pode ser expressa por uma sucessiva pode ser encontrada fazendo o produto das sucessivas transformações de ${}^{i-1}_0\mathcal{A}_i$. Conforme é mostrado na equação \eqref{fig:cine3}.
    
    \begin{equation}\label{fig:cine3}
    \begin{array}{lcl}
    {}^i_0\mathbf{T} &= & {}^0_1\mathcal{A}{}^1_2\mathcal{A} \cdots {}^{i-1}_i\mathcal{A} = \prod \limits^i_{j=1}{}^{j-1}_i\mathcal{A}, \quad \mathrm{para\;}i=1,2,\cdots,n\\[.2cm]
    & = &
    \begin{bmatrix}
    x_i & y_i & z_i & p_i\\
    0 & 0 & 0 & 1
    \end{bmatrix} = 
    \begin{bmatrix}
    {}^i_0\mathbf{R} & {}^i_0\mathcal{P}\\
    \mathbf{0} & 1
    \end{bmatrix}
    \end{array}
    \end{equation}
    
    \noindent onde, ${}^i_0\mathcal{P}$ é o vetor de orientação do referencial $i$ em relação a base $0$.


\section{Cinemática Direta e Inversa}\label{intro-ch1}

A Cinemática é a ciência que trata do movimento (geométrico) e das forças que o causam [Craig]. Desta forma, dependendo do ponto de visão,
podemos referênciar a cinemática de um robô através de uma referência externa (Cinemática externa), como por exemplo a relação entre o robô e
as coordenadas de um mapa global. Há a possibilidade também, da referência ser o próprio robô, desta forma da-se o nome de
Cinemática Interna, como exemplo, podemos citar a velocidade de rotação em torno do seu eixo ou velocidade das rodas.

Podemos ainda nos aprofundar mais sobre a Cinemática Interna do Robô, onde o espaço de ação das coordenadas definem a forma que se deve tratar o modelo de equações.
Considerando um robô fixo ou móvel com coordenadas generalizadas $\theta_1, \theta_2,..., \theta_n$ localizadas no espaço das \textcolor{red}{juntas ou atuadores (\textit{joint space}) $\mathbf{q}$}. Bem como $x_1, x_2,..., x_n$, o \textcolor{blue}{espaço das tarefas (\textit{task space}) $\mathbf{x}$}, temos então os vetores:

\begin{figure}[!ht]
\input{chapters/chapter1/figures/robot_image.tex}
\caption{Robô - Dois Graus de Liberdade}
\label{fig:2dof-robot}
\end{figure}

Assim sendo, da-se o nome de a \textcolor{red}{Cinemática Direta} quando o robô e descrito como função de entradas como (velocidade das rodas, movimento das juntas, direção das rodas).  Já a \textcolor{blue}{Cinemática Inversa} possibilita projetar um planejamento de movimento, o que significa que as entradas do robô podem ser calculadas para uma sequência de estado do robô desejada.

A relação entre as Cinemática Direta e Cinemática Inversa é obtida através da Matriz Jacobiana do Robô.

\begin{equation*}
    \mathbf{\dot{x}} = \mathbb{J}{\mathbf{\dot{q}}}
    \text{ e, }
    \mathbf{\dot{q}} = \mathbb{J}^{-1}{\mathbf{\dot{x}}}
\end{equation*}

\noindent bem como:

\begin{equation*}
    \frac{\text{d}\mathbf{x}}{\text{d}t} = \mathbb{J}\frac{\text{d}\mathbf{q}}{\text{d}t}
    \text{ e, }
    \frac{\text{d}\mathbf{q}}{\text{d}t} = \mathbb{J}^{-1}\frac{\text{d}\mathbf{x}}{\text{d}t}
\end{equation*}

\noindent onde $\mathbb{J}$ é dado por:

\begin{equation*}
    \mathbb{J}
    =
    \frac{d \mathbf{f}}{d \mathbf{q}}
    =
    \left[ \frac{\partial \mathbf{f}}{\partial q_1}
        \cdots \frac{\partial \mathbf{f}}{\partial q_n} \right]
    =
    \begin{bmatrix}
        \frac{\partial f_1}{\partial q_1} & \cdots &
        \frac{\partial f_1}{\partial q_n}                   \\
        \vdots                            & \ddots & \vdots \\
        \frac{\partial f_m}{\partial q_1} & \cdots &
        \frac{\partial f_m}{\partial q_n}
    \end{bmatrix}
\end{equation*}

Essa transformação é feita quando necessita-se, por exemplo, controlar um robô utilizando-se das referências de uma ferramenta acoplada a
extremidade do braço robótico. A Cinemática Inversa proporciona que a estratégia de controle seja aplicada na ferramenta até
que o objetivo da tarefa seja alcançado.


% \begin{shortbox}
%     \Boxhead{Exercício de Fixação}
%     Levando em consideração o braço robótico da Figura \ref{fig:2dof-robot}, encontre as equações da cinemática do robô.
%     \begin{equation*}
%         \begin{split}
%             x_f(t) = & l_1\cos(\theta_1)+l_2\cos(\theta_1 + \theta_2) \\            
%             y_f(t) = & l_1\sin(\theta_1)+l_2\sin(\theta_1 + \theta_2)
%         \end{split}
%     \end{equation*}
    
%     utilize a biblioteca \textbf{sympy} para solução do jacobiano.
%     \begin{center}
%         Resposta:

%         \qrcode[height=0.5in]{https://ocw.mit.edu/courses/mechanical-engineering/2-12-introduction-to-robotics-fall-2005/lecture-notes/chapter5.pdf}
% \end{center}

% \end{shortbox} 


\section{Cinemática de Robôs Móveis com Rodas}

Como foi visto anteriormente, a Cinemática para Robô com Rodas segue os mesmo princípios, no entanto, será necessário adicionar algumas restrições importas pelo modelo e forma de utilização de determinados tipos de rodas.
Desta forma, a discussão a seguir segue conforme o arranjo de rodas apresentado em cada tipo de robô, sejam elas rodas convencionais, rodas fíxas ou castor, conforme veremos a seguir na discussão sobre restrições.

\subsection{Cinemática Robô Diferencial}

O objeto de estudo neste texto, será o modelo de Robô Diferencial. Embora o modelo possa ser considerado simples, diante da enorme gama de aplicações, os fundamentos aqui apresentados serão de fácil aplicação as diversas outras proposta de robôs.

Um robô diferencial apresenta uma construção padrão, composta por duas rodas fixas instaladas nas laterais direita e esquerda do chassi da robô. Tipicamente uma roda no formato castor é adicionada ao chassi para dar sustentação ao chassi, esta roda, no entanto, 
não apresenta uma restrição considerável ao sistema, desta forma não será inclusa no modelo de restrições do robô diferencial.

A Figura \ref{fig:car01} mostra o Robô Diferencial descrito pelo sistema de refêrencias $\{M\}$ e $\{I\}$ representa o sistema de referência global.
As variáveis $v_{E}$ e $v_{D}$ representam respectivamente as velocidades da roda esquerda e roda da direita do chassi. A velocidade resultante do robô é expressa por $v_{M}$.
A sigla $\text{CIR}$ representa o ponto do Centro de instantâneo de Rotação. 
\begin{figure}[!ht]
    \centering
    % \input{chapters/chapter1/figures/car_1_image.tex}
    \input{chapters/chapter1/figures/car_0a_image.tex}
    \caption{Robô Diferencial}
    \label{fig:car01}
    \end{figure}

Apresentadas as variáveis do sistema é possível agora, deduzir as equações da cinemática do robô diferencial. $\omega$ representará a velocidade de rotação em relação ao $\text{CIR}$, a variável $r(t)$ é o raio em relação a cada centro de massa do chassi e $L$ a distância entre as rodas. Podemos então, definir as seguintes equações:

\begin{equation}
    \omega(t) = \frac{v_{E}(t)}{r(t) - \displaystyle\frac{L}{2}}
\end{equation}

\noindent bem, como para roda direita:

\begin{equation}
    \omega(t) = \frac{v_{D}(t)}{r(t) + \frac{L}{2}}
\end{equation}

Sendo assim, temos as seguintes expressões:

\begin{equation}
    \omega(t) = \frac{v_{D}(t) - v_{E}(t)}{L}, \quad\quad r(t) = \frac{Lv_{D}(t) + v_{E}(t)}{2v_{D}(t) - v_{E}(t)}
\end{equation}

Podemos agora definir a velocidade resultante de $v_M$ pela equação

\begin{equation}
    v_M (t) = \omega(t) r(t) = \frac{v_{D}(t) + v_{E}(t)}{2}
\end{equation}

Diante das equações listadas acima, pode-se apresentar então o modelo Cinemático do Robô Diferencial em relação ao sistema de referências global $\{I\}$, conforme equação

\begin{equation}
    \begin{bmatrix}
        \dot{X}(t) \\ \dot{Y}(t) \\ \dot{\phi}(t)
    \end{bmatrix}
    =
    \begin{bmatrix}
        \cos(\phi(t)) & 0 \\
        \sin(\phi(t)) & 0 \\
        0             & 1
    \end{bmatrix}
    \begin{bmatrix}
        v_M(t) \\ \omega(t)
    \end{bmatrix}
\end{equation}

Podemos definir também as equações locais do Robô Diferências, expressas pelo sistema referência $\{M\}$.

\begin{equation}
    \begin{bmatrix}
        \dot{x}_M(t) \\ \dot{y}_M(t) \\ \dot{\phi}(t)
    \end{bmatrix}
    =
    \begin{bmatrix}
        \frac{r_r}{2} & \frac{r_r}{2} \\
        o & 0 \\
        -\frac{r_r}{L} & \frac{r_r}{L}
    \end{bmatrix}
    \begin{bmatrix}
        \omega_E(t) \\ \omega_D(t)
    \end{bmatrix}
\end{equation}



Conforme mostrado na Figura \ref{fig:car01}, algumas restrições de movimento definem a cinemática e dinâmica do robô. No caso da Figura  \ref{fig:car01} esta restrição atua em $y_M$ onde este sempre, em condições normais, apresentará velocidade igual a zero, confome eq.

Abaixo será apresentada a relação entre as restrições de movimentos da roda em relação a dinâmica dos sistema do Robô.

\section{Dinâmica com Restrições de Movimento}

Tipicamente, um robô com rodas apresenta uma série de restrições relacionadas ao seu modelo de construção, tais restrição tem origem em limitações impostas pelas leis da cinemática e dinâmica.

As restrições dinâmicas têm origem proposta de modelo dinâmico do sistema, onde as limitação se apresentam devido a fatores como a inércia ou mesmo restrições nos atuadores \cite{klancar2017wheeled}.

Do lado da cinemática, as restrições estão relacionadas com a construção do robô e seu modelo cinemático. Podemos classificar as restrições cinemática, sendo elas holonômicas ou não holonômicas. Restrições holonômicas estão relacionadas a dimensionalidade da descrição do estado de um sistema, sendo ele expresso em coordenadas generalizadas, conforme demonstrado na \fig{fig:2dof-robot}.

Um sistema é considerado holonômico se não tiver restrições holonômicas, não apresentando assim, limitação em seu espaço de velocidades e portanto, todas as direções de movimento de espaço são possíveis. Neste aspecto, podemos considerar o Robô de dois graus de liberdade da \fig{fig:2dof-robot}, um sistema holonômico, caso não haja restrição da base do robô em $\theta_1$.

Já em um sistema não holonômico, tais restrições impedem que o robô, mova em direções arbitrárias. Um exemplo clássico é apresentado na  \fig{fig:car01}, onde o robô diferencial possui restrições ao movimento em $y'$.


\subsection{Restrições Holonômicos}
 Um sistema holonômico possui restrições que dependem das coordenadas generalizadas, como já foi visto acima. Para tais sistemas com $n$ coordenadas generalizadas $\mathbf{q} = [q_1, \cdots, q_n]$, temos a seguinte equação que expressa tais restrições.

 \begin{equation}
     f(\mathbf{q}) = f(q_1, \cdots, q_n) = 0
     \label{eq:homo}
 \end{equation}

 onde a função $f$ e sua derivada são funções contínuas.

 Observa-se também que a função da \eq{eq:homo} não depende das velocidades ou de qualquer derivada de ordem superior com relação a $t$.

 Em geral, podemos ter $m$ restrições holonômicas, ou seja $(m<n)$. Assim, exposto, pode-se agora definir es equações de energia que regem o sistema de um robô.

A formulação de Lagrange, apresentada na \eq{eq:lag1} introduz o funcional relacionado as energias conservativas do sistema robótica. Em $\mathcal{T}$ temos a composição de energias
cinéticas e em $\mathcal{V}$ as energias potenciais.

 \begin{equation}
     \mathcal{L}= \mathcal{T} - \mathcal{V}
     \label{eq:lag1}
 \end{equation}

A equação de energia cinética ($\mathcal{T}$) é dada pela \eq{eq:lag2}, onde os termos $\mathbf{M}_k$ representa as massas associadas aos $k$ elementos do sistema de equação de movimento. Já $\mathbf{J}_k $ inclui 
as forças e inércia relacionadas as sistemas rotativos.

\begin{equation}
   \mathcal{T} = \frac{1}{2} \sum\limits_{k=1}^{N}{\mathbf{\dot{q}}_k}^T  \mathbf{M}_k {\mathbf{\dot{q}}_k}+ \frac{1}{2} \sum\limits_{k=1}^{N}\mathbf{\omega}_k^T \mathbf{J}_k \mathbf{\omega}_k
   \label{eq:lag2}
\end{equation}

A equação de Energia Potencial ($\mathcal{V}$) pode ter várias definições, dependendo do tipo de sistemas potência ao qual o sistema 
robótico está incluso. Apresenta-se aqui o caso da energia Potêncial Gravitacional, definida por $\mathcal{V}_g$, conforme eq{eq:lag3}.

\begin{equation}
   \mathcal{V}_g = \sum\limits_{k=1}^{N}\mathbf{M}g \underbrace{\Delta y_k}_{\text{altura}}
   \label{eq:lag3}
\end{equation}  

\begin{tabular}{l|l}
    $\mathbf{M}$               & Massa     \\
    $\mathbf{\omega}$ & Velocidade Angular \\
    $\mathbf{J}$               & Inércia   \\
\end{tabular}

Desta forma, pode-se propor o sistema de Lagrange, conforme \eq{eq:lag4}.
\begin{equation}
    \frac{d}{\df{t}}\left( \parcial{}{\mathcal{L}}{\dot{q}_k}\right)
    -\parcial{}{\mathcal{L}}{q_k}
    = f_k, \quad k = 1,2,...,n
    \label{eq:lag4}
\end{equation}


\noindent onde $k$ é o index das coordenadas generalizadas de $g_k$, $f_k$ são as forças externas que agem no sistema.

O modelo dinâmico de um robô móvel sem restrições de movimento pode ser expresso pelo \eq{eq:lag5}.

\begin{equation}
    \mathbf{M(q)\ddot{q}+ C(q, \dot{q})+ \textcolor{red}{F(\dot{q})}+G(q) = E(q)u}
    \label{eq:lag5}
\end{equation}

\noindent onde, 

\begin{tabular}{ r | l }
  $\mathbf{q}$               & Vetor das coordenadas generalizadas    \\
  $\mathbf{M(q)}$            & Matriz de massa e inercia              \\
  $\mathbf{C(q, \dot{q})}$   & Vetor de força Coriólis e centrifuga   \\
  $\color{red}{\mathbf{F(\dot{q})}}$      & Vetor de atrito, força não conservativa\\
  $\mathbf{G(q)}$            & Vector da força gravitacional          \\
  $\mathbf{E(q)}$            & Matriz dos transformação dos atuadores \\
  $\mathbf{u}$               & Vetor de entrada do sistema            \\
\end{tabular}

% \footnotetext{As forças que não fazem parte do balanço de energia no formalismo de lagrange, devem ser adicionadas a posteriori no sistema de equações}

A solução numérica pode ser dada através da integração da aceleração ($\mathbf{\ddot{q}}$):

\begin{equation}
    \mathbf{\ddot{q}}=\mathbf{M(q)}^{-1}\left\{\mathbf{-C(q, \dot{q})-F(\dot{q})-G(q) + E(q)u}\right\}
\end{equation}



% Dito isso, usaremos o exemplo do braço robótico da Fig. \ref{fig:2dof-robot} para exrpressar o sistema em equações de estado, conforme a código abaixo:

% \begin{equation*}
%     \mathbf{X} = 
%     \begin{bmatrix}
%         \mathbf{q_1 q_2, \dot{q}_1, \dot{q}_2}.  
%     \end{bmatrix}
% \end{equation*}

% \begin{lstlisting}[language=Python]
%     def robot2dof(t,X):
%         q1  = X[0]
%         q2  = X[1]
%         dq1 = X[2] 
%         dq2 = X[3]
%         # Inertial matrix
%         Mq = np.array([...]) 
%         # C Matrix
%         Cq = np.array([...])
%         # Gravitational matrix 
%         Gq = np.array([...])
%         # Friction Force
%         ks = 0
%         Fa = ks * np.array([[dq1],[dq1]])
%         # Atuator
%         U_gain =  tau1 = tau2 = 0
%         Eu = U_gain * np.array([[tau1],[tau2]])
%         # Init Model
%         xdot = np.zeros(4,)
        
%         #dinamic
%         q2dot = inv(Mq).dot(-Cq-Fa-Gq)
%         # states
%         xdot[0] = dq1
%         xdot[1] = dq2
%         xdot[2] = q2dot[0]
%         xdot[3] = q2dot[1]

%         return xdot
% \end{lstlisting}

No entanto as aplicações de robótica móvel, como citado acima, em especial o robô diferencial, possuem restrições ao movimento. Tais restrições onde o número de restrições é superior ao grau de liberdade do sistema, ou seja,
 $(m>n)$, classifica o sistema com Não-Holonômicos. Assim, faz se necessário incluir estas restrições no modelo.


\subsection{Sistemas Não-Holonômicos}

Analogicamente ao Sistema Holonômicos, apresentados na anteriormente, Sistemas Não-Holonômicos possuem restrições alêm da restrições de vínculo, sendo assim, podemos reformular equação de restrições, contendo
agora restrições em relação as velocidades, conforme mostrado pela \eq{eq:nonhomo}.

\begin{equation}
    f(\mathbf{q}, \dot{\mathbf{q}}) = f(q_1, \cdots, q_n, \dot{q}_1, \cdots, \dot{q}_n) = 0
    \label{eq:nonhomo}
\end{equation}

As restrições cinemáticas apresentadas pela \eq{eq:nonhomo}, apenas farão parte de um sistema holonômico, conforme \cite{klancar2017wheeled}, se $f(\mathbf{q}, \dot{\mathbf{q}})$ for integrável, assim sendo, as velocidades
$\dot{q}_k$ serão eliminadas da equações e \eq{eq:nonhomo} podendo ser expressa na forma de \eq{eq:homo}.

Tais restrições, com já comentado, estão diretamente associadas as modelos de rodas utilizas no projeto de robô móvel. A \fig{fig:rodas} demonstra a variedade de opções que atendem a um leque de aplicações.
Cada modelo, impõe um restrição que poderá ser descrita geometricamente.

\begin{figure}[!ht]
    \centering
    \includegraphics[width=0.8\textwidth]{chapters/chapter1/figures/tipo_de_rodas.png}
    \caption{ (a) Rodas convencionais (b) Rodas Castor (c) Roda sueca (d) Roda Esférica. \\ Fonte: \cite{klancar2017wheeled}}
    \label{fig:rodas}
\end{figure}

Assim, retornamos ao modelo do Robô Diferencial, mostrado na \fig{fig:car01}. Como já foi discutido, as restrições impostas pelas rodas convencionais, fixadas na laterais do chassi,
possibilitam a locomoção apenas no eixo $x$, conforme demonstrado. Diante disto, temos nosso modelo cinemático do robô diferencial na \eq{eq:modcinematico}.

\begin{equation}
    \begin{bmatrix}
        \dot{X}(t) \\ \dot{Y}(t) \\ \dot{\phi}(t)
    \end{bmatrix}
    =
    \begin{bmatrix}
        \cos(\phi(t)) & 0 \\
        \sin(\phi(t)) & 0 \\
        0             & 1
    \end{bmatrix}
    \begin{bmatrix}
        v_M(t) \\ \omega(t)
    \end{bmatrix}
    \label{eq:modcinematico}
\end{equation}

Sujeito as restrições de movimento impostas pelo modelo de roda, descrito na \eq{eq:rstricoes}.

\begin{equation}
    -\dot{x}\sin(\phi) + \dot{y}\cos(\phi) = 0
    \label{eq:rstricoes}
\end{equation}

\noindent ou na forma matricial, as restrição são expressas por $\textbf{A}$, conforme:

\begin{equation}
    \mathbf{A} = 
    \begin{bmatrix}
        - \sin(\phi) & \cos(\phi) & 0
    \end{bmatrix}
    \label{eq:rstricoesmat}
\end{equation}

De forma, análoga, a \fig{fig:gocar} nos mostra as possibilidades deslocamento do Robô diferencial, bem como, percebe-se que o vetor de movimento $v'$ não é um opção valida, 
diante das restrições das rodas.

\begin{figure}[!ht]
    \centering
    \input{chapters/chapter1/figures/car_3_image.tex}
    \caption{Restrições de Movimento das Rodas do Robô Diferencial}
    \label{fig:gocar}
\end{figure}

Apresentadas as restrições, pode-se então propor o sistema dinâmico do Robô diferencial, inciando pela Formulação de Lagrange:

\begin{equation*}
    \mathcal{L}= \mathcal{T} - \mathcal{V}
\end{equation*}

A equação de energia cinética ($\mathcal{T}$) é dada por:

\begin{equation}
    \mathcal{T} = \sum\limits_{i=0}^{N-1} \frac{1}{2} {}_{i}^{i+1}\dot{\mathbf{P}}^T\cdot m_{i}\cdot {}_{i}^{i+1}\dot{\mathbf{P}}+ \mathbf{\omega}_i^T\cdot \mathbf{J}_i \cdot \mathbf{\omega}_i
\end{equation}


Para Sistemas Não-Holonômicos temos então a \eq{eq:lagrangenonhomo}, onde $k$ é o index das coordenadas generalizadas de $q_k$, $P$ representas as energias dissipativas (Atrito),
$\tau_d$ representa qualquer distúrbio no sistema, $f_k$ são as forças externas que agem no sistema e $a_{jk}$ são os coeficientes das restrições de movimento, que para o caso do 
robô diferencial, foram apresentados na \eq{eq:rstricoesmat}.
\begin{equation}
    \frac{d}{\df{t}}\left( \parcial{}{\mathcal{L}}{\dot{q}_k}\right)
    -\parcial{}{\mathcal{L}}{q_k} 
    + \parcial{}{P}{\dot{q}_k}
    +\tau_{d_k}
    = f_k - \sum\limits^{m}_{j=1}\lambda_j a_{jk}
    \label{eq:lagrangenonhomo}
\end{equation}

O modelo dinâmico de um robô móvel com restrições de movimento pode ser expresso pelo sistema de matrizes abaixo:

\begin{equation}
    \mathbf{M(q)\ddot{q}+ C(q, \dot{q})+ F(\dot{q})+G(q) = E(q)u -A}^T\mathbf{(q)}\boldsymbol{\lambda}
\end{equation}

\noindent onde:

\begin{tabular}{ r | l }
    $\mathbf{q}$               & Vetor das coordenadas generalizadas   \\
    $\mathbf{M(q)}$            & Matriz de massa e inercia             \\
    $\mathbf{C(q, \dot{q})}$   & Vetor de força Coriolis e centrifuga  \\
    $\mathbf{F(\dot{q})}$      & Vetor de atrito                       \\
    $\mathbf{G(q)}$            & Vector da força gravitacional         \\
    $\mathbf{E(q)}$            & Matriz dos transformação dos atuadores \\
    $\mathbf{u}$               & Vetor de entrada                      \\
    $\mathbf{A}^T\mathbf{(q)}$ & Matriz de restrições de movimento     \\
    $\boldsymbol{\lambda}$     & Multiplicador de Lagrange             \\
\end{tabular}


A solução para $\lambda_i$ que se opta aqui é através da pseudo-velocidades. O objetivo, em questão, é resolver as restrições de $\lambda_i$ do 
sistema de equações expresso por \eq{eq:rmrestri}.

\begin{equation}
    \mathbf{M(q)\ddot{q}+ C(q, \dot{q})+ F(\dot{q})+G(q) = E(q)u} - \textcolor{red}{\cancel{\mathbf{A}\mathbf{(q)}^T\boldsymbol{\lambda}}}
    \label{eq:rmrestri}
\end{equation}

A equação apresentada em \eq{eq:modcinematico}, apresenta o modelo cinemático, podemos então reescreve-lo no formato matricial, conforme demonstrado na \eq{eq:modcinematicomat}.

\begin{equation}
    \mathbf{\dot{q}} = \mathbf{S}(q)\mathbf{v}
    \label{eq:modcinematicomat}
\end{equation}

\eq{eq:modcinematicomat}, $\mathbf{S}(q)$ representa a matriz jacobina do modelo cinemático, já o termo $\mathbf{v}$ representa as velocidades 
que atuam no modelo. Podemos então, derivar a \eq{eq:modcinematicomat} para encontrar as equações relacionadas as acelerações do sistema.

\begin{equation}\label{eq:aprox_accel}
    \mathbf{\ddot{q}} = \mathbf{\dot{S}}(q)\mathbf{v} + \mathbf{S}(q)\mathbf{\dot{v}}
\end{equation}

Substituindo a \eq{eq:rmrestri} pela \eq{eq:aprox_accel} e aplicando a relação $\mathbf{A}(q)\mathbf{S}(q)=0$, temos a equação de aceleração do sistema expressa pela \eq{eq:pseudovelo}.

\begin{equation}
    \mathbf{\dot{v}} = \mathbf{\tilde{M}}^{-1}\left(\mathbf{\tilde{E}u - \tilde{V}} \right)
    \label{eq:pseudovelo}
\end{equation}

Se $\mathbf{S}^T\mathbf{E} \neq 0$, temos também como verdade a \eq{eq:pseudovelo2}

\begin{equation}
    \mathbf{u} = \mathbf{\tilde{E}}^{-1}\left( \mathbf{\tilde{M}\dot{v}} + \mathbf{\tilde{V}} \right)
    \label{eq:pseudovelo2}
\end{equation}

Desta forma, podemos agora reescrever o sistema apresentado acima no formato $\mathbf{\dot{x}} = f(\mathbf{x})+ g(\mathbf{x})\mathbf{u}$,
onde $\mathbf{x} = \left[ \mathbf{q}^T \, \mathbf{v}^T \right]^T$, representando assim, o sistema em espaço de estados, conforme a \eq{eq:statespace}.

\begin{equation*}
    \mathbf{\dot{x}} =
    \begin{bmatrix}
        \mathbf{S}(q)\mathbf{v} \\
        \mathbf{-\tilde{M}}^{-1}\mathbf{\tilde{V}}
    \end{bmatrix}
    +
    \begin{bmatrix}
        \mathbf{0} \\
        \mathbf{\tilde{M}}^{-1}\mathbf{\tilde{E}}
    \end{bmatrix} \mathbf{u}
    \label{eq:statespace}
\end{equation*}

\noindent onde:
\begin{equation*}
    \begin{split}
        \mathbf{\tilde{V}} & =
        \mathbf{S}(q)^T\mathbf{M}\mathbf{\dot{S}}(q)\mathbf{v} + \mathbf{S}(q)^T (\mathbf{V + F + G})\\
        \mathbf{\tilde{M}} & = \mathbf{S}(q)^T\mathbf{M}\mathbf{S}(q)\\
        \mathbf{\tilde{E}} & = \mathbf{S}(q)^T\mathbf{E}\mathbf{S}
    \end{split}
\end{equation*}

\noindent sendo:
\begin{tabular}{ r | l }
    $\mathbf{x}$ & Vetor de estados \\
    $\mathbf{S}$ & Matriz Jacobiana \\
\end{tabular}

Definidas as equações para um Sistema Não-Holonômico, como o caso do Robô Diferencial apresentado na \fig{fig:car01}, podemos então definir 
as equações da dinâmica. O primeiro passo é a definição das energia cinética $\mathcal{T}$ e potêncial $\mathcal{V}$, conforme a \eq{eq:lag1}.

\begin{equation}
    \mathcal{T} = \frac{m}{2}\left(\dot{x}^2+\dot{y}^2\right)+ \frac{J}{2}\phi^2
    \label{eq:diffcardin}
\end{equation}

Para equação da energia potencial, temos $\mathcal{V} = 0$. Desta forma, o funcional pode ser definido por:

\begin{equation}
    \mathcal{L} = \mathcal{T} - \mathcal{V} = \frac{m}{2}\left(\dot{x}^2+\dot{y}^2\right)+ \frac{J}{2}\phi^2
    \label{eq:diffcardin2}
\end{equation}

As forças não conservativa não são consideradas na formulação do lagrange, podendo assim, ser adicionadas ao final da formulação. Temos então a \eq{eq:diffcardin3}.

\begin{equation}
    \begin{split}
        \frac{d}{\df{t}}\left( \parcial{}{\mathcal{L}}{\dot{x}}\right) = m\ddot{x} \\
        \frac{d}{\df{t}}\left( \parcial{}{\mathcal{L}}{\dot{y}}\right) = m\ddot{y} \\
        \frac{d}{\df{t}}\left( \parcial{}{\mathcal{L}}{\dot{\phi}}\right) = J\ddot{\phi} 
    \end{split}
    \label{eq:diffcardin3}
\end{equation}


\noindent bem como,

\begin{equation}
    \begin{split}
        \frac{d}{\df{t}}\left( \parcial{}{\mathcal{L}}{x}\right) = 0 \\
        \frac{d}{\df{t}}\left( \parcial{}{\mathcal{L}}{y}\right) = 0 \\
        \frac{d}{\df{t}}\left( \parcial{}{\mathcal{L}}{\phi}\right) = 0
    \end{split}
    \label{eq:diffcardin4}
\end{equation}

Adicionando as forças que atuam no robô diferencial, temos então:

\begin{equation}
    \begin{split}
    m\ddot{x} - \lambda_1 \sin(\phi) = F_x \\
    m\ddot{y} - \lambda_2 \cos(\phi) = F_y \\
    J\ddot{\phi} = \mathbb{T}
    \end{split}
\end{equation}

Temos então $F_x = 1/r\left( \tau_{d}+ \tau_{e}\right)\cos(\phi)$, sendo $\tau_d, \tau_e$ o torque da roda direita e esquerda, respectivamente.
Bem como, $F_y = 1/r\left( \tau_{d}+ \tau_{e}\right)\sin(\phi)$, sendo a força aplicada no eixo $y$. O torque aplicado no veículo é dado por $\mathbb{T}= L/(2r)\left( \tau_d - \tau_e \right)$,
temos então:

\begin{equation}
    \begin{split}
        m\ddot{x} - \lambda_1 \sin(\phi) - \frac{1}{r}\left( \tau_d + \tau_e \right) \cos(\phi)= 0 \\
        m\ddot{y} - \lambda_2 \cos(\phi) - \frac{1}{r}\left( \tau_d + \tau_e \right) \sin(\phi)= 0 \\
        J\ddot{\phi} - \frac{L}{2r}\left( \tau_d - \tau_e \right)= 0
    \end{split}
\end{equation}

O sistema de equações do Robô Diferencial, pode agora, ser reescrito no formato matricial, definido na \eq{eq:rmrestri}, conforme a \eq{eq:rmrestri2}.

\begin{equation}
    \mathbf{M(q)\ddot{q}}+ \mathbf{C(q, \dot{q})}+ \mathbf{F(\dot{q})}+ \mathbf{G(q)} = \mathbf{E(q)u}
    - \mathbf{A(q)^T}\boldsymbol{\lambda}
    \label{eq:rmrestri2}
\end{equation}

sendo as matrizes definidas por:

\begin{equation*}
    \mathbf{M} = 
    \begin{bmatrix}
        m & 0 & 0 \\
        0 & m & 0 \\
        0 & 0 & J
    \end{bmatrix}, \quad
    \mathbf{E} = \frac{1}{r}
    \begin{bmatrix}
        \cos(\phi) & \cos(\phi) \\
        \sin(\phi) & \sin(\phi) \\
        \frac{L}{1} & -\frac{L}{2}
    \end{bmatrix}, \quad 
    \mathbf{u} = 
    \begin{bmatrix}
        \tau_1 \\
        \tau_2
    \end{bmatrix}, \quad \text{e}
\end{equation*}

\noindent a matriz de restrição,

\begin{equation*}
    \mathbf{A} = 
    \begin{bmatrix}
        -\sin(\phi) & \cos(\phi) & 0
    \end{bmatrix}
\end{equation*}

Aplicando a relação demonstrada pela \eq{eq:pseudovelo}, podemos então resolver as restrições do sistema de equação.

\begin{equation*}
    \mathbf{\tilde{M}} = 
    \begin{bmatrix}
        m & 0 \\
        0 & J
    \end{bmatrix}, \quad
    \mathbf{\tilde{V}} = 
    \begin{bmatrix}
        0 \\ 0
    \end{bmatrix}, \quad \text{e} \quad
    \mathbf{\tilde{E}} = \frac{1}{r}
    \begin{bmatrix}
        1 & 1\\
        \displaystyle\frac{L}{2} & - \displaystyle\frac{L}{2}
    \end{bmatrix}
\end{equation*}

Desta forma, o sistema em espaço de estados na forma $\mathbf{x} = f(\mathbf{\dot{x}}) + g(\mathbf{x})\mathbf{u}$, conforme mostrado
pela \eq{eq:fullmodel}.

\begin{equation}
    \begin{bmatrix}
        \dot{x} \\ \dot{y} \\ \dot{\phi} \\ \dot{v} \\ \dot{\omega}
    \end{bmatrix} = 
    \begin{bmatrix}
        v\cos(\phi) \\ v\sin(\phi) \\ \omega \\ 0 \\ 0
    \end{bmatrix} + 
    \begin{bmatrix}
        0 & 0 \\
        0 & 0 \\
        0 & 0 \\
        \frac{1}{mr} & \frac{1}{mr} \\
        \frac{L}{2Jr} & -\frac{L}{2Jr}
    \end{bmatrix}
    \begin{bmatrix}
        \tau_d \\ \tau_e
    \end{bmatrix}
    \label{eq:fullmodel}
\end{equation}

Assim é definido o modelo dinâmico do Robô Diferencial, conforme demostrado acima.
Embora o modelo represente a dinâmica do robô, certas incertezas, quanto ao modelo ou mesmo ao sensores
envolvidos no modelo, podem então fazer com que o sistema real divirja consideravelmente do modelo.
Desta forma, serão apresentados alguns métodos não determinísticos para melhorar a proposta de robô diferencial.

